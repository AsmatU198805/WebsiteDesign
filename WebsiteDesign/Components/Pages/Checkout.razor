@page "/checkout"
@rendermode InteractiveServer

@inject CartService CartService
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject HttpClient Http

<h3>Checkout</h3>

@if (!loaded)
{
    <p>Loading checkout...</p>
}
else if (!cart.Any())
{
    <div class="alert alert-warning">
        Your cart is empty
    </div>
}
else
{
    <div class="row">
        <!-- LEFT: CUSTOMER INFO -->
        <div class="col-md-6">
            <div class="card p-3">
                <h5>Customer Information</h5>

                <input class="form-control mb-2"
                       placeholder="Full Name"
                       @bind="order.Name" />

                <input class="form-control mb-2"
                       placeholder="Email"
                       @bind="order.Email" />

                <input class="form-control mb-2"
                       placeholder="Phone"
                       @bind="order.Phone" />

                <textarea class="form-control mb-2"
                          placeholder="Address"
                          @bind="order.Address"></textarea>

                <button class="btn btn-success w-100"
                        disabled="@placingOrder"
                        @onclick="PlaceOrder">
                    @(placingOrder ? "Placing Order..." : "Place Order")
                </button>
            </div>
        </div>

        <!-- RIGHT: ORDER SUMMARY -->
        <div class="col-md-6">
            <div class="card p-3">
                <h5>Order Summary</h5>

                @foreach (var item in cart)
                {
                    <div class="d-flex justify-content-between">
                        <span>@item.Name (x @item.Quantity)</span>
                        <span>Rs. @(item.Price* item.Quantity)</span>
                    </div>
                }

                <hr />

                <h5 class="text-end">
                    Total: <b>Rs. @total</b>
                </h5>
            </div>
        </div>
    </div>
}

@code {

    List<CartItem> cart = new();
    bool loaded;
    bool placingOrder;
    decimal total;

    OrderModel order = new();
    User obj = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        // Load cart safely
        cart = await CartService.GetCart();
        total = cart.Sum(x => x.Price * x.Quantity);

        // Load logged-in user from localStorage safely
        try
        {
            var userJson = await JS.InvokeAsync<string>("localStorage.getItem", "loggedUser");
            if (!string.IsNullOrEmpty(userJson))
            {
                obj = System.Text.Json.JsonSerializer.Deserialize<User>(userJson) ?? new();
                order.Name = obj.Name;
                order.Email = obj.Email;
            }
        }
        catch (InvalidOperationException)
        {
            // prerender safety
        }

        loaded = true;
        await InvokeAsync(StateHasChanged);
    }

    async Task PlaceOrder()
    {
        if (placingOrder) return;
        if (!cart.Any()) return;
        if (string.IsNullOrWhiteSpace(order.Name) ||
            string.IsNullOrWhiteSpace(order.Phone) ||
            string.IsNullOrWhiteSpace(order.Address))
            return;

        placingOrder = true;

        try
        {
            var orderMaster = new TblOrderMaster
            {
                UserId = obj.UserId,
                OrderDetails = cart.Select(x => new TblOrderDetail
                {
                    ProductId = x.ProductId,
                    Quantity = x.Quantity,
                    Rate = x.Price
                }).ToList()
            };

            var response = await Http.PostAsJsonAsync("api/Orders/place-order", orderMaster);

            if (response.IsSuccessStatusCode)
            {
                await CartService.ClearCart();
                Nav.NavigateTo("/order-success", true);
            }
            else
            {
                Console.WriteLine("Order placement failed");
                // Optionally show toast / alert
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error placing order: {ex.Message}");
        }
        finally
        {
            placingOrder = false;
        }
    }

    public class OrderModel
    {
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string Phone { get; set; } = "";
        public string Address { get; set; } = "";
    }
}
